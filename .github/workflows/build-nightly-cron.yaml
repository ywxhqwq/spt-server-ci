name: SPT-Server No-Watermark Build

on:
  # åŠ å…¥æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  workflow_dispatch:
  # ä¿ç•™å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©è‡ªåŠ¨è·‘ä¸€æ¬¡ï¼ˆå¦‚æœä½ ä¸éœ€è¦è‡ªåŠ¨è·‘ï¼Œå¯ä»¥æŠŠ schedule è¿™ä¸‰è¡Œåˆ æ‰ï¼‰
  schedule:
    - cron: '30 2 * * *'
  push:
    paths:
      - '.github/workflows/build-nightly-cron.yaml'

env:
  SERVER_URL: https://github.com
  REPOSITORY_SPT_SERVER: sp-tarkov/server-csharp
  NIGHTLY_BRANCH: develop

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      PROCEED: ${{ steps.compare-hash.outputs.PROCEED }}
      BUILT_HASH: ${{ steps.compare-hash.outputs.BUILT_HASH }}
      CLIENT_VERSION: ${{ steps.versions.outputs.CLIENT_VERSION }}
      SPT_VERSION: ${{ steps.versions.outputs.SPT_VERSION }}
      SPT_COMMIT_ID: ${{ steps.versions.outputs.SPT_COMMIT_ID }}
      BUILD_DATE_TIME: ${{ steps.versions.outputs.DATE_TIME }}
      # !!! å…³é”®ä¿®æ”¹ï¼šè¿™é‡Œå¼ºåˆ¶æ”¹ä¸º Releaseï¼Œå½»åº•å»æ°´å° !!!
      BUILD_TYPE: Release 
      BUILD_CONFIG: Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get Latest Commit From SPT
        id: get-latest-commit
        run: |
          SPT_COMMIT_ID=$(git ls-remote ${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}.git refs/heads/${{ env.NIGHTLY_BRANCH }} | awk '{print $1}')
          SPT_COMMIT_ID=${SPT_COMMIT_ID:0:8}
          echo "ğŸ‘½ SPT_COMMIT_ID = $SPT_COMMIT_ID"
          echo "SPT_COMMIT_ID=$SPT_COMMIT_ID" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Compare Hashes (Force Proceed for Manual)
        id: compare-hash
        run: |
          # ç®€åŒ–é€»è¾‘ï¼šå¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘(workflow_dispatch)ï¼Œæˆ–è€…åŸæœ¬çš„é€»è¾‘åˆ¤æ–­éœ€è¦æ›´æ–°ï¼Œéƒ½ç»§ç»­ç¼–è¯‘
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "âœ… Manual trigger detected. Forcing build."
             echo "PROCEED=true" >> $GITHUB_OUTPUT
          else
             # è¿™é‡Œä¿ç•™åŸæœ¬çš„æ£€æµ‹é€»è¾‘ï¼Œé˜²æ­¢è‡ªåŠ¨ä»»åŠ¡é‡å¤ç¼–è¯‘
             git pull
             if [ -f "trigger.nightly" ]; then
               source trigger.nightly
               server_last_built_hash=${server:0:8}
             else
               server_last_built_hash="none"
             fi
             
             server_latest_commit_hash=${{ steps.get-latest-commit.outputs.SPT_COMMIT_ID }}
             
             if [ "$server_last_built_hash" != "$server_latest_commit_hash" ]; then
               echo "âœ… New commit detected. Proceeding."
               echo "PROCEED=true" >> $GITHUB_OUTPUT
             else
               echo "ğŸ›‘ No updates found."
               echo "PROCEED=false" >> $GITHUB_OUTPUT
             fi
             echo "BUILT_HASH=$server_last_built_hash" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Extract versions
        id: versions
        if: steps.compare-hash.outputs.PROCEED == 'true'
        run: |
          SPT_COMMIT_ID=${{ steps.get-latest-commit.outputs.SPT_COMMIT_ID }}

          latest_tag=$(git ls-remote --tags ${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}.git | awk -F'/' '{print $NF}' | grep -v '\^{}' | sort -V | tail -1)
          SPT_VERSION=$(echo $latest_tag | cut -d'-' -f1)

          # Extract versions from core.json
          wget https://raw.githubusercontent.com/${{ env.REPOSITORY_SPT_SERVER }}/refs/heads/${{ env.NIGHTLY_BRANCH }}/Libraries/SPTarkov.Server.Assets/SPT_Data/configs/core.json
          CLIENT_VERSION=$(jq -r '.compatibleTarkovVersion' core.json)

          echo "CLIENT_VERSION=$CLIENT_VERSION" >> $GITHUB_OUTPUT
          echo "SPT_VERSION=$SPT_VERSION" >> $GITHUB_OUTPUT
          echo "SPT_COMMIT_ID=$SPT_COMMIT_ID" >> $GITHUB_OUTPUT
          echo "DATE_TIME=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
        shell: bash

  build-server-host:
    needs: prepare
    if: needs.prepare.outputs.PROCEED == 'true'
    runs-on: ubuntu-latest
    # å¦‚æœä½ ä¸æƒ³ç”¨ refringe çš„é•œåƒï¼Œå¯ä»¥ç”¨æ ‡å‡†çš„ mcr.microsoft.com/dotnet/sdk:9.0
    # ä½†ä¸ºäº†ç¨³å¦¥ä¿ç•™åŸä½œè€…çš„ç¼–è¯‘ç¯å¢ƒè®¾ç½®
    container:
      image: refringe/spt-build-dotnet:2.0.2
    outputs:
      SPT_COMMIT_TIME: ${{ steps.debug-info.outputs.SPT_COMMIT_TIME }}
      WIN_ARTIFACT: ${{ steps.filename.outputs.WIN_ARTIFACT }}
      WIN_RELEASE_FILE: ${{ steps.filename.outputs.WIN_RELEASE }}
      LINUX_ARTIFACT: ${{ steps.filename.outputs.LINUX_ARTIFACT }}
      LINUX_RELEASE_FILE: ${{ steps.filename.outputs.LINUX_RELEASE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Server
        run: |
          git clone -b ${{ env.NIGHTLY_BRANCH }} --depth=1 ${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}.git /snapshot
          cd /snapshot
          git lfs pull

      - name: Runner Debug Information
        id: debug-info
        run: |
          cd /snapshot
          echo "COMMIT_ID_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "SPT_COMMIT_TIME"=$(git log --pretty=format:"%ai" ${{ env.NIGHTLY_BRANCH }} -1) >> $GITHUB_OUTPUT
        shell: bash

      # å¦‚æœä½ æ²¡æœ‰ custom/bg.pngï¼Œè¿™ä¸€æ­¥å¯èƒ½ä¼šæŠ¥é”™ã€‚å¦‚æœä½ ä¸éœ€è¦æ¢èƒŒæ™¯å›¾ï¼Œå¯ä»¥æŠŠè¿™æ­¥åˆ æ‰
      # - name: Replace Background Image
      #   id: bg
      #   run: |
      #     cp custom/bg.png /snapshot/Libraries/SPTarkov.Server.Assets/SPT_Data/images/launcher/
      #   shell: bash

      - name: Replace projectName For Windows
        run: |
          cd /snapshot/Libraries/SPTarkov.Server.Assets/SPT_Data/configs
          git checkout core.json
          # æ”¹ä¸ªåå­—ï¼Œæ–¹ä¾¿ä½ çŸ¥é“è¿™æ˜¯ä½ è‡ªå·±ç¼–è¯‘çš„ç‰ˆæœ¬
          sed -i "s/\"projectName\": \"SPT\",/\"projectName\": \"My Clean SPT (Win)\",/g" core.json
        shell: bash

      - name: Publish Windows Server
        run: |
          dotnet publish ./SPTarkov.Server/SPTarkov.Server.csproj \
            -c ${{ needs.prepare.outputs.BUILD_CONFIG }} \
            -f net9.0 \
            -r win-x64 \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:PublishSingleFile=true \
            --self-contained false \
            -p:SptBuildType=${{ needs.prepare.outputs.BUILD_TYPE }} \
            -p:SptVersion=${{ needs.prepare.outputs.SPT_VERSION }} \
            -p:SptBuildTime=$( date +%Y%m%d ) \
            -p:SptCommit=${{ steps.debug-info.outputs.COMMIT_ID_SHORT }} \
            -p:IsPublish=true
        shell: bash
        working-directory: /snapshot

      - name: Generate File Name
        id: filename
        run: |
          win_artifact_name=spt-server-${{ needs.prepare.outputs.SPT_VERSION }}-win-clean-${{ steps.debug-info.outputs.COMMIT_ID_SHORT }}
          win_release_name=${win_artifact_name}.zip
          echo "WIN_ARTIFACT=$win_artifact_name" >> $GITHUB_OUTPUT
          echo "WIN_RELEASE=$win_release_name" >> $GITHUB_OUTPUT
          # Linux çš„åå­—ä¹Ÿé¡ºä¾¿ç”Ÿæˆä¸€ä¸‹ï¼Œè™½ç„¶ä½ å¯èƒ½ä¸ç”¨
          echo "LINUX_ARTIFACT=spt-server-linux-clean" >> $GITHUB_OUTPUT
          echo "LINUX_RELEASE=spt-server-linux-clean.zip" >> $GITHUB_OUTPUT
        shell: bash

      - name: Artifact Windows Server
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filename.outputs.WIN_ARTIFACT }}
          path: |
            /snapshot/SPTarkov.Server/bin/${{ needs.prepare.outputs.BUILD_CONFIG }}/net9.0/win-x64/publish/
            !/snapshot/SPTarkov.Server/bin/${{ needs.prepare.outputs.BUILD_CONFIG }}/net9.0/win-x64/publish/**/*.pdb
          overwrite: true

  assemble-and-publish:
    # è¿™ä¸€æ­¥ç°åœ¨åªä¾èµ– build-server-hostï¼Œå»æ‰äº† docker å’Œ update-trigger
    needs: [prepare, build-server-host]
    if: needs.prepare.outputs.PROCEED == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write # éœ€è¦å†™æƒé™æ¥å‘å¸ƒ Release

    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-server-host.outputs.WIN_ARTIFACT }}
          path: windows

      - name: Compress Releases
        id: compress-release
        run: |
          cd windows
          zip -r ../${{ needs.build-server-host.outputs.WIN_RELEASE_FILE }} *
          ls -R ..
        shell: bash

      - name: Create Github Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Clean Build ${{ needs.prepare.outputs.BUILD_DATE_TIME }}"
          tag_name: "clean-${{ needs.prepare.outputs.BUILD_DATE_TIME }}-${{ github.run_number }}"
          prerelease: true
          body: |
            ## çº¯å‡€ç‰ˆæ„å»º (æ— æ°´å°)
            
            **SPT Version**: ${{ needs.prepare.outputs.SPT_VERSION }}
            **Tarkov Version**: ${{ needs.prepare.outputs.CLIENT_VERSION }}
            **Commit**: ${{ needs.prepare.outputs.SPT_COMMIT_ID }}
            
            > [!TIP]
            > è¿™ä¸ªç‰ˆæœ¬ç§»é™¤äº† Nightly ç‰ˆçš„æµ®åŠ¨æ°´å°å’Œçº¢è‰²è­¦å‘Šã€‚
            > åªæœ‰ Windows ç‰ˆæœ¬ã€‚ä¸‹è½½åè¯·è§£å‹è¦†ç›–åˆ°æ¸¸æˆç›®å½•ã€‚
            
          files: |
            ${{ needs.build-server-host.outputs.WIN_RELEASE_FILE }}
