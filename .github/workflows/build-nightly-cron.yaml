name: SPT-Server No-Watermark Build

on:
  workflow_dispatch:
  schedule:
    - cron: '30 2 * * *'
  push:
    paths:
      - '.github/workflows/build-nightly-cron.yaml'

env:
  SERVER_URL: https://github.com
  REPOSITORY_SPT_SERVER: sp-tarkov/server-csharp
  NIGHTLY_BRANCH: develop

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      PROCEED: ${{ steps.compare-hash.outputs.PROCEED }}
      BUILT_HASH: ${{ steps.compare-hash.outputs.BUILT_HASH }}
      CLIENT_VERSION: ${{ steps.versions.outputs.CLIENT_VERSION }}
      SPT_VERSION: ${{ steps.versions.outputs.SPT_VERSION }}
      SPT_COMMIT_ID: ${{ steps.versions.outputs.SPT_COMMIT_ID }}
      BUILD_DATE_TIME: ${{ steps.versions.outputs.DATE_TIME }}
      # å¿…é¡»ç”¨ BLEEDINGEDGEMODSï¼Œåªæœ‰è¿™ä¸ªç¯å¢ƒçš„ä»£ç æ˜¯æ´»çš„
      BUILD_CONFIG: BLEEDINGEDGEMODS
      # å¿…é¡»ç”¨ Releaseï¼Œåªæœ‰è¿™ä¸ªèº«ä»½èƒ½å»æ°´å°
      BUILD_TYPE: Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get Latest Commit From SPT
        id: get-latest-commit
        run: |
          SPT_COMMIT_ID=$(git ls-remote ${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}.git refs/heads/${{ env.NIGHTLY_BRANCH }} | awk '{print $1}')
          SPT_COMMIT_ID=${SPT_COMMIT_ID:0:8}
          echo "SPT_COMMIT_ID=$SPT_COMMIT_ID" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Compare Hashes
        id: compare-hash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "PROCEED=true" >> $GITHUB_OUTPUT
          else
             git pull
             if [ -f "trigger.nightly" ]; then
               source trigger.nightly
               server_last_built_hash=${server:0:8}
             else
               server_last_built_hash="none"
             fi
             server_latest_commit_hash=${{ steps.get-latest-commit.outputs.SPT_COMMIT_ID }}
             if [ "$server_last_built_hash" != "$server_latest_commit_hash" ]; then
               echo "PROCEED=true" >> $GITHUB_OUTPUT
             else
               echo "PROCEED=false" >> $GITHUB_OUTPUT
             fi
             echo "BUILT_HASH=$server_last_built_hash" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Extract versions
        id: versions
        if: steps.compare-hash.outputs.PROCEED == 'true'
        run: |
          SPT_COMMIT_ID=${{ steps.get-latest-commit.outputs.SPT_COMMIT_ID }}
          latest_tag=$(git ls-remote --tags ${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}.git | awk -F'/' '{print $NF}' | grep -v '\^{}' | sort -V | tail -1)
          SPT_VERSION=$(echo $latest_tag | cut -d'-' -f1)
          wget https://raw.githubusercontent.com/${{ env.REPOSITORY_SPT_SERVER }}/refs/heads/${{ env.NIGHTLY_BRANCH }}/Libraries/SPTarkov.Server.Assets/SPT_Data/configs/core.json
          CLIENT_VERSION=$(jq -r '.compatibleTarkovVersion' core.json)
          echo "CLIENT_VERSION=$CLIENT_VERSION" >> $GITHUB_OUTPUT
          echo "SPT_VERSION=$SPT_VERSION" >> $GITHUB_OUTPUT
          echo "SPT_COMMIT_ID=$SPT_COMMIT_ID" >> $GITHUB_OUTPUT
          echo "DATE_TIME=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
        shell: bash

  build-server-host:
    needs: prepare
    if: needs.prepare.outputs.PROCEED == 'true'
    runs-on: ubuntu-latest
    container:
      image: refringe/spt-build-dotnet:2.0.2
    outputs:
      SPT_COMMIT_TIME: ${{ steps.debug-info.outputs.SPT_COMMIT_TIME }}
      WIN_ARTIFACT: ${{ steps.filename.outputs.WIN_ARTIFACT }}
      WIN_RELEASE_FILE: ${{ steps.filename.outputs.WIN_RELEASE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Server
        run: |
          git clone -b ${{ env.NIGHTLY_BRANCH }} --depth=1 ${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}.git /snapshot
          cd /snapshot
          git lfs pull

      - name: Runner Debug Information
        id: debug-info
        run: |
          cd /snapshot
          echo "COMMIT_ID_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "SPT_COMMIT_TIME"=$(git log --pretty=format:"%ai" ${{ env.NIGHTLY_BRANCH }} -1) >> $GITHUB_OUTPUT
        shell: bash

      - name: Replace projectName For Windows
        run: |
          cd /snapshot/Libraries/SPTarkov.Server.Assets/SPT_Data/configs
          git checkout core.json
          sed -i "s/\"projectName\": \"SPT\",/\"projectName\": \"SPT (Clean)\",/g" core.json
        shell: bash

      # ----------------------------------------------------------------
      # å…³é”®æ­¥éª¤ï¼šåœ¨ BLEEDINGEDGEMODS ç¯å¢ƒä¸‹ï¼Œå¼ºè¡Œæ‹†é™¤æŠ¥è­¦å™¨
      # 1. ä¸ç¢° Nullableï¼ˆé¿å…è¯­æ³•å´©åï¼‰
      # 2. åˆ æ‰ TreatWarningsAsErrorsï¼ˆé¿å…è­¦å‘Šå¡æ­»ï¼‰
      # ----------------------------------------------------------------
      - name: Remove Warning Locks
        run: |
          cd /snapshot
          echo "ğŸ”§ Removing strict warning limitations..."
          
          # ç‰©ç†åˆ é™¤æ‰€æœ‰ TreatWarningsAsErrors é…ç½®
          find . -type f -name "*.csproj" -exec sed -i '/<TreatWarningsAsErrors>/d' {} +
          
          # ç‰©ç†åˆ é™¤æ‰€æœ‰ WarningsAsErrors é…ç½®
          find . -type f -name "*.csproj" -exec sed -i '/<WarningsAsErrors>/d' {} +
          
          echo "âœ… Project files relaxed."
        shell: bash

      - name: Publish Windows Server
        run: |
          # æ ¸å¿ƒç»„åˆæ‹³ï¼š
          # -c BLEEDINGEDGEMODS (ä»£ç èƒ½è·‘)
          # -p:SptBuildType=Release (èº«ä»½æ˜¯å¯¹çš„)
          # -p:TreatWarningsAsErrors=false (å¼ºåˆ¶ä¸æŠ¥é”™)
          dotnet publish ./SPTarkov.Server/SPTarkov.Server.csproj \
            -c ${{ needs.prepare.outputs.BUILD_CONFIG }} \
            -f net9.0 \
            -r win-x64 \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:PublishSingleFile=true \
            --self-contained false \
            -p:SptBuildType=${{ needs.prepare.outputs.BUILD_TYPE }} \
            -p:SptVersion=${{ needs.prepare.outputs.SPT_VERSION }} \
            -p:SptBuildTime=$( date +%Y%m%d ) \
            -p:SptCommit=${{ steps.debug-info.outputs.COMMIT_ID_SHORT }} \
            -p:IsPublish=true \
            -p:TreatWarningsAsErrors=false
        shell: bash
        working-directory: /snapshot

      - name: Generate File Name
        id: filename
        run: |
          win_artifact_name=spt-server-${{ needs.prepare.outputs.SPT_VERSION }}-win-clean-${{ steps.debug-info.outputs.COMMIT_ID_SHORT }}
          win_release_name=${win_artifact_name}.zip
          echo "WIN_ARTIFACT=$win_artifact_name" >> $GITHUB_OUTPUT
          echo "WIN_RELEASE=$win_release_name" >> $GITHUB_OUTPUT
        shell: bash

      - name: Artifact Windows Server
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filename.outputs.WIN_ARTIFACT }}
          path: |
            /snapshot/SPTarkov.Server/bin/${{ needs.prepare.outputs.BUILD_CONFIG }}/net9.0/win-x64/publish/
            !/snapshot/SPTarkov.Server/bin/${{ needs.prepare.outputs.BUILD_CONFIG }}/net9.0/win-x64/publish/**/*.pdb
          overwrite: true

  assemble-and-publish:
    needs: [prepare, build-server-host]
    if: needs.prepare.outputs.PROCEED == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-server-host.outputs.WIN_ARTIFACT }}
          path: windows

      - name: Compress Releases
        id: compress-release
        run: |
          cd windows
          zip -r ../${{ needs.build-server-host.outputs.WIN_RELEASE_FILE }} *
        shell: bash

      - name: Create Github Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Clean Build ${{ needs.prepare.outputs.BUILD_DATE_TIME }}"
          tag_name: "clean-${{ needs.prepare.outputs.BUILD_DATE_TIME }}-${{ github.run_number }}"
          prerelease: true
          body: |
            ## çº¯å‡€ç‰ˆæ„å»º
            Configuration: BLEEDINGEDGEMODS (ç¡®ä¿ç¨³å®š)
            Identity: Release (å»é™¤æ°´å°)
          files: |
            ${{ needs.build-server-host.outputs.WIN_RELEASE_FILE }}
